<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MintIQ Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Typing cursor animation */
        .cursor-blink {
            display: inline-block;
            width: 4px;
            height: 16px;
            background-color: currentColor;
            animation: blink 1s step-end infinite;
            vertical-align: middle;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Send = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
        const Settings = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const ShieldAlert = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const Heart = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>;
        const X = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const AlertTriangle = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const Info = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;

        const App = () => {
          const [messages, setMessages] = useState([
            {
              id: 1,
              role: 'chatbot',
              text: "Hello, I'm the MintIQ support companion. I'm here to listen. How have you been feeling lately?"
            }
          ]);
          const [input, setInput] = useState('');
          const [isStreaming, setIsStreaming] = useState(false);
          const [apiKey, setApiKey] = useState(localStorage.getItem('mintiq_api_key') || '');
          const [showSettings, setShowSettings] = useState(!apiKey);
          const [showCrisis, setShowCrisis] = useState(false);
          
          const messagesEndRef = useRef(null);

          const SYSTEM_PREAMBLE = `
            You are MintIQ, a compassionate, specialized mental health support assistant. 

            YOUR CORE GOALS:
            1.  Deep Empathy & Mindset Alignment: Listen actively. Validate feelings briefly.
            2.  Conversational Screening: Help explore symptoms gently (depression/anxiety).
            3.  Actionable Coping: Offer simple coping mechanisms when appropriate.

            STRICT SCOPE:
            * Mental Health Only: If asked about coding, sports, weather, math, etc., politely refuse.
            * Refusal: "I am a specialized mental health assistant. Let's focus on youâ€”how are you feeling?"

            OUTPUT STYLE:
            * Short & Concise: 2-3 sentences max.
            * One Question at a Time.
            * Tone: Warm, soothing, patient.

            CRITICAL SAFETY:
            1.  Non-Medical: Never diagnose. Say "It sounds like you might be experiencing symptoms of..."
            2.  Crisis Intervention: If suicide/self-harm is mentioned, urge them to call emergency services immediately.
          `;

          // Auto-scroll on new messages
          useEffect(() => {
            scrollToBottom();
          }, [messages]);

          // Save API key
          useEffect(() => {
            if(apiKey) localStorage.setItem('mintiq_api_key', apiKey);
          }, [apiKey]);

          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
          };

          const handleSend = async () => {
            if (!input.trim()) return;
            if (!apiKey) {
              setShowSettings(true);
              return;
            }

            const userText = input;
            const userMessage = { id: Date.now(), role: 'user', text: userText };
            
            // 1. Update UI with User Message
            setMessages(prev => [...prev, userMessage]);
            setInput('');
            setIsStreaming(true);

            // 2. Create Placeholder for Bot Message
            const botMessageId = Date.now() + 1;
            setMessages(prev => [...prev, { id: botMessageId, role: 'chatbot', text: '' }]);

            try {
              const response = await fetch('https://api.cohere.ai/v1/chat', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json',
                  'X-Client-Name': 'MintIQ-Web'
                },
                body: JSON.stringify({
                  message: userText,
                  preamble: SYSTEM_PREAMBLE,
                  stream: true, // ENABLE STREAMING
                  model: 'command-r-08-2024', // FASTER MODEL
                  temperature: 0.6,
                  chat_history: messages.map(m => ({
                    role: m.role === 'user' ? 'USER' : 'CHATBOT',
                    message: m.text
                  }))
                })
              });

              if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.message || "Connection failed");
              }

              // 3. Process the Stream
              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let botFullResponse = "";

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                  if (line.trim() === '') continue;
                  try {
                    const json = JSON.parse(line);
                    if (json.event_type === 'text-generation') {
                      botFullResponse += json.text;
                      
                      // Live Update
                      setMessages(prev => 
                        prev.map(msg => 
                          msg.id === botMessageId ? { ...msg, text: botFullResponse } : msg
                        )
                      );
                    }
                  } catch (e) {
                    // Ignore parsing errors for partial JSON chunks
                    console.log("Stream parse error (ignorable):", e);
                  }
                }
              }

            } catch (error) {
              setMessages(prev => prev.map(msg => 
                msg.id === botMessageId 
                  ? { ...msg, text: "I'm having trouble connecting right now. Please check your API key or internet connection." } 
                  : msg
              ));
              if(error.message.includes('401') || error.message.includes('key')) setShowSettings(true);
            } finally {
              setIsStreaming(false);
            }
          };

          const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              handleSend();
            }
          };

          return (
            <div className="flex flex-col h-[100dvh] bg-slate-50 font-sans text-slate-800 relative overflow-hidden">
              
              {/* Background */}
              <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-teal-100 to-slate-50 -z-10"></div>
              
              {/* Header */}
              <header className="flex items-center justify-between px-4 py-3 bg-white/80 backdrop-blur-md border-b border-teal-100 sticky top-0 z-20 shadow-sm">
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 bg-teal-500 rounded-lg flex items-center justify-center shadow-teal-200 shadow-lg">
                    <Heart className="w-5 h-5 text-white fill-current" />
                  </div>
                  <h1 className="text-lg font-bold bg-gradient-to-r from-teal-600 to-teal-400 bg-clip-text text-transparent">
                    MintIQ
                  </h1>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setShowCrisis(!showCrisis)} className="flex items-center gap-1 px-3 py-1.5 text-xs font-semibold text-rose-600 bg-rose-50 border border-rose-200 rounded-full hover:bg-rose-100">
                    <ShieldAlert className="w-4 h-4" /> <span className="hidden sm:inline">Crisis</span>
                  </button>
                  <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 hover:text-teal-600 hover:bg-teal-50 rounded-full">
                    <Settings className="w-5 h-5" />
                  </button>
                </div>
              </header>

              {/* Settings Modal */}
              {showSettings && (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                    <div className="bg-teal-600 p-4 flex justify-between items-center text-white">
                      <h2 className="font-semibold flex items-center gap-2"><Settings className="w-4 h-4" /> Setup</h2>
                      {apiKey && <button onClick={() => setShowSettings(false)}><X className="w-4 h-4" /></button>}
                    </div>
                    <div className="p-6 space-y-4">
                      <p className="text-sm text-slate-600">Enter your Cohere API Key (stored locally).</p>
                      <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Ex: xxxxxxxxxxxxxxxxxxxx" className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none text-sm font-mono bg-slate-50" />
                      <div className="bg-blue-50 border border-blue-100 p-3 rounded-lg text-xs text-blue-700 flex gap-2">
                        <Info className="w-4 h-4 flex-shrink-0" />
                        <p>Get a free trial key at <a href="https://dashboard.cohere.com/api-keys" target="_blank" className="underline font-bold">cohere.com</a>.</p>
                      </div>
                      <button onClick={() => setShowSettings(false)} disabled={!apiKey} className="w-full py-3 bg-teal-600 hover:bg-teal-700 disabled:bg-slate-300 text-white font-medium rounded-xl transition-colors shadow-lg">Save & Start</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Crisis Modal */}
              {showCrisis && (
                <div className="absolute inset-0 z-40 bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center p-6 text-center animate-in fade-in">
                  <ShieldAlert className="w-16 h-16 text-rose-500 mb-4" />
                  <h2 className="text-2xl font-bold text-slate-800 mb-2">You are not alone.</h2>
                  <div className="space-y-3 w-full max-w-sm mt-4">
                    <a href="tel:988" className="block w-full py-3 bg-rose-600 text-white font-bold rounded-xl">Call 988 (Crisis Line)</a>
                    <a href="tel:911" className="block w-full py-3 bg-slate-200 text-slate-700 font-bold rounded-xl">Call Emergency (911)</a>
                  </div>
                  <button onClick={() => setShowCrisis(false)} className="mt-8 text-sm text-slate-500 underline">Return to chat</button>
                </div>
              )}

              {/* Chat Area */}
              <main className="flex-1 overflow-y-auto p-4 space-y-6">
                <div className="max-w-2xl mx-auto space-y-6 pb-4">
                  <div className="text-center py-2">
                     <div className="inline-flex items-center gap-2 px-3 py-1 bg-teal-50 text-teal-700 text-[10px] uppercase tracking-wider rounded-full font-bold border border-teal-100">
                       <AlertTriangle className="w-3 h-3" /> Non-Medical AI
                     </div>
                  </div>

                  {messages.map((msg) => (
                    <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[85%] md:max-w-[75%] rounded-2xl p-4 shadow-sm relative leading-relaxed
                        ${msg.role === 'user' ? 'bg-teal-600 text-white rounded-br-none' : 'bg-white border border-slate-100 text-slate-700 rounded-bl-none'}`}>
                        {msg.text.split('\n').map((line, i) => (
                          <p key={i} className={i > 0 ? 'mt-2' : ''}>
                            {line}
                            {/* Cursor Logic: Only show on last line of last message if streaming */}
                            {isStreaming && msg.id === messages[messages.length-1].id && i === msg.text.split('\n').length - 1 && (
                                <span className="cursor-blink"></span>
                            )}
                          </p>
                        ))}
                      </div>
                    </div>
                  ))}
                  <div ref={messagesEndRef} />
                </div>
              </main>

              {/* Input */}
              <footer className="bg-white border-t border-slate-100 p-4">
                <div className="max-w-2xl mx-auto flex gap-2">
                  <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleKeyPress} placeholder="Type how you feel..." className="flex-1 bg-slate-50 border border-slate-200 text-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 transition-all placeholder:text-slate-400" />
                  <button onClick={handleSend} disabled={isStreaming || !input.trim()} className="bg-teal-600 hover:bg-teal-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white p-3 rounded-xl transition-all shadow-lg shadow-teal-100">
                    <Send className="w-5 h-5" />
                  </button>
                </div>
              </footer>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>