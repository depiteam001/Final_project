<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - MentIQ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-header {
            background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .profile-header h1 {
            margin: 0;
            font-size: 28px;
            cursor: pointer;
        }
        
        .profile-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 137, 123, 0.1);
        }
        
        .profile-section h2 {
            color: #00695c;
            margin-bottom: 20px;
            border-bottom: 2px solid #00897b;
            padding-bottom: 10px;
        }
        
        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .info-value {
            color: #333;
            font-size: 16px;
        }
        
        .appointment-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #00897b;
        }
        
        .appointment-card h4 {
            margin: 0 0 10px 0;
            color: #00695c;
        }
        
        .appointment-card p {
            margin: 5px 0;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .assessment-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .risk-score-display {
            font-size: 48px;
            font-weight: bold;
            color: #00695c;
            margin: 15px 0;
        }
        
        .risk-level-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            margin: 10px 0;
        }
        
        .risk-low {
            background: #4caf50;
            color: white;
        }
        
        .risk-moderate {
            background: #ff9800;
            color: white;
        }
        
        .risk-high {
            background: #f44336;
            color: white;
        }
        
        .risk-very {
            background: #d32f2f;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .dark-mode .profile-section {
            background: #1e1e1e;
            color: #e0e0e0;
        }
        
        .dark-mode .profile-section h2 {
            color: #b2ebf2;
            border-bottom-color: #00897b;
        }
        
        .dark-mode .info-label {
            color: #b0b0b0;
        }
        
        .dark-mode .info-value {
            color: #e0e0e0;
        }
        
        .dark-mode .appointment-card {
            background: #2a2a2a;
            border-left-color: #00897b;
        }
        
        .dark-mode .appointment-card h4 {
            color: #b2ebf2;
        }
        
        .dark-mode .appointment-card p {
            color: #b0b0b0;
        }
    </style>
</head>
<body>
    <div class="profile-header">
        <h1 id="profileHeaderLogo">üß† MentIQ</h1>
    </div>
    
    <div class="profile-container">
        <!-- User Information Section -->
        <div class="profile-section">
            <h2>üë§ My Information</h2>
            <div class="user-info" id="userInfo">
                <div class="info-item">
                    <span class="info-label">Name</span>
                    <span class="info-value" id="userName">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email</span>
                    <span class="info-value" id="userEmail">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Account Type</span>
                    <span class="info-value" id="userType">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Assessment Section -->
        <div class="profile-section">
            <h2>üß† Mental Health Assessment</h2>
            <div id="assessmentSection">
                <div class="empty-state">
                    <p>Loading assessment data...</p>
                </div>
            </div>
        </div>
        
                <!-- Appointments Section -->
                <div class="profile-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üìÖ My Appointments</h2>
                        <button class="btn btn-secondary" onclick="refreshAppointments()" style="padding: 8px 16px; font-size: 14px;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="appointmentsSection">
                        <div class="empty-state">
                            <p>Loading appointments...</p>
                        </div>
                    </div>
                </div>
    </div>
    
    <script>
        // API base URL
        const getApiBaseUrl = () => {
            const port = window.location.port;
            const hostname = window.location.hostname;
            
            if (port === '5000' || (!port && hostname === 'localhost')) {
                return '';
            }
            return 'http://localhost:5000';
        };
        
        const API_BASE_URL = getApiBaseUrl();
        
        // Load theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                document.body.classList.add('dark-mode');
            }
        }
        
        // Load user profile data
        async function loadProfile() {
            try {
                // Load user info
                const userData = localStorage.getItem('currentUser');
                if (userData) {
                    const user = JSON.parse(userData);
                    const userType = user.user_type || user.type || 'patient';
                    
                    document.getElementById('userName').textContent = user.name || 'N/A';
                    document.getElementById('userEmail').textContent = user.email || 'N/A';
                    document.getElementById('userType').textContent = userType.charAt(0).toUpperCase() + userType.slice(1);
                    
                    // For doctors, hide assessment section and show different info
                    if (userType === 'doctor') {
                        document.getElementById('assessmentSection').parentElement.style.display = 'none';
                        // Add doctor-specific info
                        const userInfoDiv = document.getElementById('userInfo');
                        const specialtyDiv = document.createElement('div');
                        specialtyDiv.className = 'info-item';
                        specialtyDiv.innerHTML = `
                            <span class="info-label">Specialty</span>
                            <span class="info-value" id="userSpecialty">${user.specialty || 'N/A'}</span>
                        `;
                        userInfoDiv.appendChild(specialtyDiv);
                    } else {
                        // For patients, load assessment
                        await loadAssessment();
                    }
                }
                
                // Load appointments (for both doctors and patients)
                await loadAppointments();
                
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Load assessment data
        async function loadAssessment() {
            const assessmentSection = document.getElementById('assessmentSection');
            
            try {
                // Check localStorage first
                const localAssessment = localStorage.getItem('mentalHealthAssessment');
                
                if (localAssessment) {
                    const assessment = JSON.parse(localAssessment);
                    displayAssessment(assessment);
                    return;
                }
                
                // Try to get from API if logged in
                const response = await fetch(`${API_BASE_URL}/api/profile/assessment`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.assessment) {
                        displayAssessment(data.assessment);
                        return;
                    }
                }
                
                // No assessment found
                assessmentSection.innerHTML = `
                    <div class="empty-state">
                        <p>You haven't taken the assessment yet.</p>
                        <button class="btn btn-primary" onclick="window.location.href='assessment.html'" style="margin-top: 20px;">
                            üß† Take Assessment Now
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading assessment:', error);
                assessmentSection.innerHTML = `
                    <div class="empty-state">
                        <p>You haven't taken the assessment yet.</p>
                        <button class="btn btn-primary" onclick="window.location.href='assessment.html'" style="margin-top: 20px;">
                            üß† Take Assessment Now
                        </button>
                    </div>
                `;
            }
        }
        
        // Display assessment results
        function displayAssessment(assessment) {
            const assessmentSection = document.getElementById('assessmentSection');
            const riskLevel = assessment.riskLevel || assessment.risk_level || 'Unknown';
            const riskScore = assessment.riskScore || assessment.risk_score || 0;
            const assessmentDate = assessment.assessmentDate || assessment.created_at || new Date().toISOString();
            
            const riskClass = riskLevel.toLowerCase().replace(' ', '-');
            
            assessmentSection.innerHTML = `
                <div class="assessment-card">
                    <div class="risk-score-display">${riskScore}/100</div>
                    <div class="risk-level-badge risk-${riskClass}">${riskLevel} Risk</div>
                    <p style="margin-top: 15px; color: #666;">Completed: ${new Date(assessmentDate).toLocaleDateString()}</p>
                    <button class="btn btn-secondary" onclick="window.location.href='assessment.html'" style="margin-top: 15px;">
                        Retake Assessment
                    </button>
                </div>
            `;
        }
        
        // Load appointments from database
        async function loadAppointments() {
            const appointmentsSection = document.getElementById('appointmentsSection');
            
            // Show loading state
            appointmentsSection.innerHTML = `
                <div class="empty-state">
                    <p>Loading appointments...</p>
                </div>
            `;
            
            try {
                console.log('Loading appointments from API...');
                // Always fetch from API to get latest data from database
                const response = await fetch(`${API_BASE_URL}/api/profile/appointments`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    cache: 'no-cache' // Ensure fresh data
                });
                
                console.log('Appointments API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Appointments API response data:', data);
                    
                    if (data.success) {
                        const appointments = data.appointments || [];
                        console.log(`Loaded ${appointments.length} appointments from database`);
                        
                        if (appointments.length > 0) {
                            displayAppointments(appointments);
                        } else {
                            // No appointments found
                            const userData = localStorage.getItem('currentUser');
                            const user = userData ? JSON.parse(userData) : null;
                            const userType = user ? (user.user_type || user.type || 'patient') : 'patient';
                            
                            if (userType === 'doctor') {
                                appointmentsSection.innerHTML = `
                                    <div class="empty-state">
                                        <p>No appointments scheduled yet.</p>
                                        <p style="margin-top: 10px; font-size: 14px;">Appointments will appear here when patients book consultations with you.</p>
                                    </div>
                                `;
                            } else {
                                appointmentsSection.innerHTML = `
                                    <div class="empty-state">
                                        <p>No appointments scheduled yet.</p>
                                        <button class="btn btn-primary" onclick="window.location.href='index.html#doctors'" style="margin-top: 20px;">
                                            Find a Doctor
                                        </button>
                                    </div>
                                `;
                            }
                        }
                        return;
                    } else {
                        console.error('API returned success=false:', data.error);
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Failed to load appointments:', response.status, errorData);
                }
                
                // Error or no appointments - show empty state
                const userData = localStorage.getItem('currentUser');
                const user = userData ? JSON.parse(userData) : null;
                const userType = user ? (user.user_type || user.type || 'patient') : 'patient';
                
                if (userType === 'doctor') {
                    appointmentsSection.innerHTML = `
                        <div class="empty-state">
                            <p>No appointments scheduled yet.</p>
                            <p style="margin-top: 10px; font-size: 14px;">Appointments will appear here when patients book consultations with you.</p>
                        </div>
                    `;
                } else {
                    appointmentsSection.innerHTML = `
                        <div class="empty-state">
                            <p>No appointments scheduled yet.</p>
                            <button class="btn btn-primary" onclick="window.location.href='index.html#doctors'" style="margin-top: 20px;">
                                Find a Doctor
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading appointments:', error);
                appointmentsSection.innerHTML = `
                    <div class="empty-state">
                        <p>Error loading appointments. Please refresh the page.</p>
                        <button class="btn btn-primary" onclick="loadAppointments()" style="margin-top: 20px;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Display appointments
        function displayAppointments(appointments) {
            const appointmentsSection = document.getElementById('appointmentsSection');
            const userData = localStorage.getItem('currentUser');
            const user = userData ? JSON.parse(userData) : null;
            const userType = user ? (user.user_type || user.type || 'patient') : 'patient';
            
            if (appointments.length === 0) {
                if (userType === 'doctor') {
                    appointmentsSection.innerHTML = `
                        <div class="empty-state">
                            <p>No appointments scheduled yet.</p>
                            <p style="margin-top: 10px; font-size: 14px;">Appointments will appear here when patients book consultations with you.</p>
                        </div>
                    `;
                } else {
                    appointmentsSection.innerHTML = `
                        <div class="empty-state">
                            <p>No appointments scheduled yet.</p>
                            <button class="btn btn-primary" onclick="window.location.href='index.html#doctors'" style="margin-top: 20px;">
                                Find a Doctor
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            appointmentsSection.innerHTML = appointments.map(apt => {
                if (userType === 'doctor') {
                    // For doctors, show patient info
                    const patientName = apt.patient_name || apt.patient || 'Unknown Patient';
                    const patientEmail = apt.patient_email || '';
                    const date = apt.appointment_date || apt.date || 'TBD';
                    const time = apt.appointment_time || apt.time || 'TBD';
                    const status = apt.status || 'pending';
                    
                    return `
                        <div class="appointment-card">
                            <h4>${patientName}</h4>
                            <p>üìß ${patientEmail || 'N/A'}</p>
                            <p>üìÖ ${date} at ${time}</p>
                            <span class="status-badge status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                        </div>
                    `;
                } else {
                    // For patients, show doctor info
                    const doctorName = apt.doctor || apt.doctor_name || 'Unknown Doctor';
                    const location = apt.location || `${apt.city || ''}, ${apt.country || ''}`.trim() || 'Location TBD';
                    const date = apt.appointment_date || apt.date || 'TBD';
                    const time = apt.appointment_time || apt.time || 'TBD';
                    const status = apt.status || 'pending';
                    
                    // Pending appointments can be canceled, confirmed cannot
                    if (status === 'pending') {
                        return `
                            <div class="appointment-card" id="appointment-${apt.id}">
                                <h4>${doctorName}</h4>
                                <p>üìç ${location}</p>
                                <p>üìÖ ${date} at ${time}</p>
                                <span class="status-badge status-${status}" id="status-${apt.id}">Pending - Awaiting Doctor Confirmation</span>
                                <p style="margin-top: 10px; color: #666; font-size: 14px;">This appointment is pending confirmation from the doctor.</p>
                                <button class="btn btn-danger btn-sm" onclick="cancelAppointment(${apt.id})" style="margin-top: 10px;">Cancel Appointment</button>
                            </div>
                        `;
                    } else if (status === 'confirmed') {
                        return `
                            <div class="appointment-card" id="appointment-${apt.id}">
                                <h4>${doctorName}</h4>
                                <p>üìç ${location}</p>
                                <p>üìÖ ${date} at ${time}</p>
                                <span class="status-badge status-${status}" id="status-${apt.id}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                                <p style="margin-top: 10px; color: #666; font-size: 14px;">This appointment is confirmed and cannot be canceled.</p>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="appointment-card" id="appointment-${apt.id}">
                                <h4>${doctorName}</h4>
                                <p>üìç ${location}</p>
                                <p>üìÖ ${date} at ${time}</p>
                                <span class="status-badge status-${status}" id="status-${apt.id}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                            </div>
                        `;
                    }
                }
            }).join('');
        }
        
        // Set logo redirect based on user type
        function setupLogoRedirect() {
            const logo = document.getElementById('profileHeaderLogo');
            const userData = localStorage.getItem('currentUser');
            
            if (logo && userData) {
                try {
                    const user = JSON.parse(userData);
                    const userType = user.user_type || user.type || 'patient';
                    
                    if (userType === 'doctor') {
                        logo.onclick = () => window.location.href = 'doctor-dashboard.html';
                    } else {
                        logo.onclick = () => window.location.href = 'index.html';
                    }
                } catch (error) {
                    logo.onclick = () => window.location.href = 'index.html';
                }
            } else if (logo) {
                logo.onclick = () => window.location.href = 'index.html';
            }
        }

        // Function to refresh appointments (called when status changes)
        async function refreshAppointments() {
            console.log('Refreshing appointments from database...');
            await loadAppointments();
        }
        
        // Cancel appointment (delete from database)
        async function cancelAppointment(appointmentId) {
            if (!confirm('Are you sure you want to cancel this appointment? This action cannot be undone.')) {
                return;
            }
            
            try {
                console.log(`Deleting appointment ${appointmentId} from ${API_BASE_URL}/api/appointments/${appointmentId}`);
                const response = await fetch(`${API_BASE_URL}/api/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                console.log('Delete response status:', response.status);
                const data = await response.json();
                console.log('Delete response data:', data);
                
                if (data.success) {
                    alert('Appointment canceled successfully.');
                    await loadAppointments(); // Reload appointments
                } else {
                    alert('Error: ' + (data.error || 'Failed to cancel appointment'));
                }
            } catch (error) {
                console.error('Error canceling appointment:', error);
                alert('An error occurred while canceling the appointment. Check console for details.');
            }
        }
        
        // Poll for appointment updates every 5 seconds (optional - can be removed if not needed)
        // setInterval(refreshAppointments, 5000);
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadProfile();
            setupLogoRedirect();
            
            // Manual refresh only - no automatic refresh
        });
    </script>
</body>
</html>

